<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Energy Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card:hover {
      transform: scale(1.05);
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }
  </style>
</head>
<body class="bg-gray-100 text-gray-800">
  <header class="flex items-center justify-between bg-green-700 text-white p-4">
    <button class="text-2xl" onclick="toggleSidebar()">â˜°</button>
    <h1 class="text-2xl font-bold">Smart Energy Dashboard</h1>
    <div id="liveTime" class="text-sm"></div>
  </header>

  <div id="selectedPathName" class="text-center text-gray-600 mt-2 text-sm">(No Path Selected)</div>

  <div class="fixed top-0 left-0 h-full w-64 bg-gray-900 text-white z-50 transform -translate-x-full transition-transform duration-300" id="sidebar">
    <h2 class="text-lg font-bold p-4 border-b border-gray-700">Select Path</h2>
    <ul id="pathList" class="divide-y divide-gray-800"></ul>
  </div>

  <main class="p-4 container mx-auto">
    <section id="cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></section>
    <section class="bg-white p-4 rounded shadow mb-8">
      <h3 class="text-lg font-semibold mb-2">Selected Value Trends</h3>
      <canvas id="lineChart"></canvas>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCKlCqcbgQ_ebfQhgpSKSKz2N6TFLGbHyY",
      authDomain: "esp-983b0.firebaseapp.com",
      databaseURL: "https://esp-983b0-default-rtdb.firebaseio.com",
      projectId: "esp-983b0",
      storageBucket: "esp-983b0.appspot.com",
      messagingSenderId: "225766961278",
      appId: "1:225766961278:web:f8fe9a9a65917c6e9a6066"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const cardsContainer = document.getElementById("cards");
    const pathList = document.getElementById("pathList");
    const selectedPathName = document.getElementById("selectedPathName");
    const sidebar = document.getElementById("sidebar");
    const liveTime = document.getElementById("liveTime");

    let currentPathRef = null;
    let selectedFields = [];
    const timeLabels = [];
    const fieldData = {};

    function toggleSidebar() {
      sidebar.classList.toggle("-translate-x-full");
    }

    function updateLiveTime() {
      const options = { timeZone: 'Asia/Karachi', hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' };
      liveTime.textContent = new Date().toLocaleTimeString('en-US', options);
    }

    setInterval(updateLiveTime, 1000);
    updateLiveTime();

    const lineChartCtx = document.getElementById('lineChart').getContext('2d');
    const lineChart = new Chart(lineChartCtx, {
      type: 'line',
      data: {
        labels: timeLabels,
        datasets: []
      },
      options: {
        responsive: true,
        scales: {
          x: { title: { display: true, text: 'Time' } },
          y: { title: { display: true, text: 'Value' } }
        }
      }
    });

    function readAllPaths() {
      const rootRef = ref(db);
      onValue(rootRef, (snapshot) => {
        pathList.innerHTML = "";
        snapshot.forEach((child) => {
          const path = child.key;
          const li = document.createElement("li");
          li.textContent = path;
          li.classList = "p-4 hover:bg-gray-700 cursor-pointer";
          li.onclick = () => {
            selectPath(path);
            toggleSidebar();
          };
          pathList.appendChild(li);
        });
      });
    }

    function selectPath(path) {
      if (currentPathRef) currentPathRef.off();
      selectedPathName.textContent = `Path: ${path}`;
      cardsContainer.innerHTML = "";
      selectedFields = [];
      timeLabels.length = 0;
      lineChart.data.datasets = [];
      lineChart.update();

      const dataRef = ref(db, path);
      currentPathRef = dataRef;

      onValue(dataRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        cardsContainer.innerHTML = "";

        Object.entries(data).forEach(([key, value]) => {
          const card = document.createElement("div");
          card.className = `card bg-white p-4 rounded-2xl shadow-md text-center border cursor-pointer`;
          card.onclick = () => toggleSelection(key);
          card.innerHTML = `
            <div class="text-gray-500 text-xs mb-1">${key}</div>
            <div class="text-lg font-bold text-gray-800">${typeof value === "number" ? value.toFixed(2) : value}</div>
          `;
          cardsContainer.appendChild(card);

          if (!fieldData[key]) fieldData[key] = [];
          fieldData[key].push(value);
          if (fieldData[key].length > 20) fieldData[key].shift();

          if (selectedFields.includes(key)) {
            const index = lineChart.data.datasets.findIndex(ds => ds.label === key);
            if (index !== -1) {
              lineChart.data.datasets[index].data = fieldData[key];
            }
          }
        });

        const now = new Date().toLocaleTimeString();
        timeLabels.push(now);
        if (timeLabels.length > 20) timeLabels.shift();

        lineChart.data.labels = [...timeLabels];
        lineChart.update();
      });
    }

    function toggleSelection(field) {
      if (selectedFields.includes(field)) {
        selectedFields = selectedFields.filter(f => f !== field);
        lineChart.data.datasets = lineChart.data.datasets.filter(ds => ds.label !== field);
      } else {
        if (selectedFields.length >= 3) {
          alert("You can select up to 3 fields.");
          return;
        }
        selectedFields.push(field);
        lineChart.data.datasets.push({
          label: field,
          data: fieldData[field] || [],
          borderColor: getRandomColor(),
          fill: false,
          tension: 0.1
        });
      }
      lineChart.update();
    }

    function getRandomColor() {
      const r = Math.floor(Math.random() * 255);
      const g = Math.floor(Math.random() * 255);
      const b = Math.floor(Math.random() * 255);
      return `rgb(${r}, ${g}, ${b})`;
    }

    readAllPaths();
  </script>
</body>
</html>
