<!DOCTYPE html>
<html>
<head>
  <title>Firebase Chart Viewer</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-subtitle@1.1.0"></script>
  <style>
    body { font-family: Arial; background: #f0f0f0; text-align: center; }
    canvas { background: white; border: 1px solid #ccc; }
    .path-selector { margin: 20px; padding: 10px; background: #fff; border: 1px solid #ccc; display: inline-block; max-height: 300px; overflow-y: auto; }
    .checkbox-label { display: block; text-align: left; }
  </style>
</head>
<body>

<h2>üìà Firebase Realtime Chart Viewer</h2>

<div id="pathContainer" class="path-selector"></div>

<canvas id="lineChart" width="1000" height="400"></canvas>

<script>
  // üîí Password protection
  const correctPassword = "123456";
  const inputPassword = prompt("Enter password to view this page:");
  if (inputPassword !== correctPassword) {
    alert("‚ùå Incorrect password!");
    document.body.innerHTML = "<h1>Access Denied</h1>";
    throw new Error("Unauthorized");
  }

  // ‚úÖ Firebase config
  const firebaseConfig = {
    apiKey: "dq08PQL2JHCpD13e9295WjatZXFnQOZLCH7Ez4aO",
    authDomain: "esp-983b0.firebaseapp.com",
    databaseURL: "https://esp-983b0-default-rtdb.firebaseio.com/",
    projectId: "esp-983b0",
    storageBucket: "esp-983b0.appspot.com",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_ID"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const paths = [
    "3PhaseData", "3PhaseData1", "3PhaseData5",
    "Home1", "Home10", "Home2", "Home3", "Home33", "Home4",
    "Home5", "Home6", "Home7", "Home8", "Home9",
    "ModbusData", "adnan", "compressor", "energyLogs",
    "energy_data", "productivityLogs", "smart_home",
    "smart_home1", "smart_home2", "smart_home3", "testData"
  ];

  const pathContainer = document.getElementById("pathContainer");

  // üîò Add checkbox for each path
  paths.forEach(path => {
    const label = document.createElement("label");
    label.className = "checkbox-label";
    label.innerHTML = `<input type="checkbox" value="${path}" onchange="updateSelectedPaths()"> ${path}`;
    pathContainer.appendChild(label);
  });

  let selectedPaths = [];

  // üìä Chart setup
  const ctx = document.getElementById("lineChart").getContext("2d");
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      datasets: []
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'üì° Real-time Firebase Data'
        },
        subtitle: {
          display: true,
          text: 'üìÖ Timestamp: ',
          font: { size: 14 }
        }
      },
      scales: {
        x: {
          type: 'time',
          time: { unit: 'minute' },
          title: { display: true, text: 'Time' }
        },
        y: {
          title: { display: true, text: 'Value' }
        }
      }
    }
  });

  function updateSelectedPaths() {
    selectedPaths = [];
    document.querySelectorAll("#pathContainer input:checked").forEach(cb => {
      selectedPaths.push(cb.value);
    });
    fetchDataAndUpdateChart();
  }

  async function fetchDataAndUpdateChart() {
    chart.data.datasets = [];

    const colors = [
      "red", "blue", "green", "orange", "purple", "brown", "pink", "cyan", "lime", "magenta",
      "darkblue", "darkgreen", "teal", "gold", "indigo", "coral", "crimson", "navy"
    ];

    let colorIndex = 0;

    for (const path of selectedPaths) {
      try {
        const snapshot = await db.ref(path).limitToLast(20).once("value");
        const data = snapshot.val();
        if (!data) continue;

        const labels = [];
        const values = [];

        for (const key in data) {
          const entry = data[key];
          const ts = entry.Timestamp || entry.timestamp || entry.time || Date.now();
          const value = entry.totalPower || entry.power || entry.energy || entry.kWh || entry.value || 0;
          labels.push(new Date(ts * 1000));
          values.push(value);
        }

        chart.data.datasets.push({
          label: path,
          data: labels.map((time, i) => ({ x: time, y: values[i] })),
          borderColor: colors[colorIndex++ % colors.length],
          fill: false,
          tension: 0.1
        });

      } catch (err) {
        console.error("Failed to load path:", path, err);
      }
    }

    chart.options.plugins.subtitle.text = `Last Updated: ${new Date().toLocaleString()}`;
    chart.update();
  }

  // Auto refresh every 30 seconds
  setInterval(() => {
    if (selectedPaths.length > 0) fetchDataAndUpdateChart();
  }, 30000);
</script>

</body>
</html>
