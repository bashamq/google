<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ESP Firebase Real-time Chart</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.1.0"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }
    canvas {
      max-width: 100%;
    }
    #passwordPrompt {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      background: #111;
      color: white;
    }
    .toggle-wrapper {
      margin: 20px;
    }
    label {
      margin: 0 10px;
    }
  </style>
</head>
<body>
  <div id="passwordPrompt">
    <h2>ðŸ”’ Enter Password to View Chart</h2>
    <input type="password" id="passwordInput" placeholder="Enter password...">
    <button onclick="checkPassword()">Submit</button>
  </div>

  <div id="content" style="display:none">
    <div class="container">
      <h2>ESP Firebase Real-time Chart</h2>

      <div class="toggle-wrapper">
        <strong>Choose Data Path(s):</strong><br />
        <div id="pathCheckboxes"></div>
      </div>

      <canvas id="dataChart"></canvas>
    </div>
  </div>

  <script>
    const PASSWORD = "admin"; // change as needed

    function checkPassword() {
      const input = document.getElementById("passwordInput").value;
      if (input === PASSWORD) {
        document.getElementById("passwordPrompt").style.display = "none";
        document.getElementById("content").style.display = "block";
      } else {
        alert("Incorrect password!");
      }
    }

    const firebaseConfig = {
      apiKey: "dq08PQL2JHCpD13e9295WjatZXFnQOZLCH7Ez4aO",
      authDomain: "esp-983b0.firebaseapp.com",
      databaseURL: "https://esp-983b0-default-rtdb.firebaseio.com/",
      projectId: "esp-983b0",
      storageBucket: "esp-983b0.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const paths = [
      "3PhaseData", "3PhaseData1", "3PhaseData5",
      "Home1", "Home10", "Home2", "Home3", "Home33", "Home4",
      "Home5", "Home6", "Home7", "Home8", "Home9",
      "ModbusData", "adnan", "compressor", "energyLogs",
      "energy_data", "productivityLogs", "smart_home",
      "smart_home1", "smart_home2", "smart_home3",
      "testData"
    ];

    const pathCheckboxes = document.getElementById("pathCheckboxes");
    paths.forEach(path => {
      const label = document.createElement("label");
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.value = path;
      checkbox.onchange = updateDataSources;
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + path));
      pathCheckboxes.appendChild(label);
    });

    const ctx = document.getElementById("dataChart").getContext("2d");
    const dataChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: []
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            display: true
          },
          subtitle: {
            display: true,
            text: 'Realtime Data vs Time'
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'minute'
            },
            title: {
              display: true,
              text: 'Time'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Value'
            }
          }
        }
      }
    });

    const activeListeners = {};

    function updateDataSources() {
      const checkedPaths = Array.from(document.querySelectorAll('#pathCheckboxes input:checked')).map(c => c.value);

      Object.keys(activeListeners).forEach(path => {
        if (!checkedPaths.includes(path)) {
          db.ref(path).off('value', activeListeners[path]);
          delete activeListeners[path];
          dataChart.data.datasets = dataChart.data.datasets.filter(d => d.label !== path);
        }
      });

      checkedPaths.forEach(path => {
        if (!activeListeners[path]) {
          const listener = snapshot => {
            const data = snapshot.val();
            const time = new Date();
            const numeric = Object.values(data).filter(v => typeof v === 'number');
            const avg = numeric.reduce((a, b) => a + b, 0) / numeric.length;

            let dataset = dataChart.data.datasets.find(d => d.label === path);
            if (!dataset) {
              dataset = {
                label: path,
                data: [],
                borderWidth: 2,
                fill: false
              };
              dataChart.data.datasets.push(dataset);
            }

            dataset.data.push({ x: time, y: avg });
            if (dataset.data.length > 100) dataset.data.shift();

            dataChart.update();
          };
          db.ref(path).on('value', listener);
          activeListeners[path] = listener;
        }
      });
    }
  </script>
</body>
</html>
