<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Energy Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #343a40; color: #fff; padding: 10px 20px; text-align: center; }
    .container { display: flex; flex-wrap: wrap; }
    .sidebar { flex: 1 1 200px; padding: 15px; background: #fff; min-width: 250px; }
    .main { flex: 3 1 600px; padding: 15px; }
    .data-table { width: 100%; border-collapse: collapse; background: #fff; }
    .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; }
    .data-table th { background: #007bff; color: white; }
    button { padding: 10px 15px; margin: 5px; cursor: pointer; }
    input[type="datetime-local"] { padding: 5px; margin: 5px; }
    @media (max-width: 768px) {
      .container { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header>
    <h2>Smart Energy Dashboard</h2>
  </header>
  <div class="container">
    <div class="sidebar">
      <h3>Data Sources</h3>
      <label><input type="checkbox" id="selectAll"> Select All / Deselect All</label>
      <div id="checkboxes"></div>
      <h4>Filter by Date/Time</h4>
      <input type="datetime-local" id="fromDate"> to
      <input type="datetime-local" id="toDate">
      <button onclick="exportCSV()">Export to CSV</button>
    </div>
    <div class="main">
      <table class="data-table" id="dataTable">
        <thead>
          <tr id="tableHeaders"></tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      databaseURL: "https://esp-983b0-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const checkboxContainer = document.getElementById("checkboxes");
    const dataTable = document.getElementById("dataTable");
    const tableHeaders = document.getElementById("tableHeaders");
    const tableBody = document.getElementById("tableBody");

    const fromInput = document.getElementById("fromDate");
    const toInput = document.getElementById("toDate");

    document.getElementById("selectAll").addEventListener("change", function () {
      document.querySelectorAll(".sourceCheckbox").forEach(cb => cb.checked = this.checked);
      fetchData();
    });

    function getTimestamp(obj) {
      return obj.Timestamp ? Number(obj.Timestamp) : 0;
    }

    function fetchPaths() {
      db.ref().once("value").then(snapshot => {
        const paths = Object.keys(snapshot.val() || {});
        checkboxContainer.innerHTML = "";
        paths.forEach(path => {
          const label = document.createElement("label");
          label.innerHTML = `<input type='checkbox' class='sourceCheckbox' value='${path}' checked> ${path}`;
          checkboxContainer.appendChild(label);
        });
        document.querySelectorAll(".sourceCheckbox").forEach(cb => {
          cb.addEventListener("change", fetchData);
        });
        fetchData();
      });
    }

    function fetchData() {
      tableBody.innerHTML = "";
      tableHeaders.innerHTML = "";
      const selectedPaths = Array.from(document.querySelectorAll(".sourceCheckbox:checked"))
        .map(cb => cb.value);
      if (selectedPaths.length === 0) return;

      let allData = [];
      let fromTs = fromInput.value ? new Date(fromInput.value).getTime() : null;
      let toTs = toInput.value ? new Date(toInput.value).getTime() : null;

      let headersSet = new Set();

      selectedPaths.forEach(path => {
        db.ref(path).once("value").then(snapshot => {
          const dataObj = snapshot.val();
          if (!dataObj) return;
          Object.values(dataObj).forEach(entry => {
            const ts = getTimestamp(entry);
            if ((fromTs === null || ts >= fromTs) && (toTs === null || ts <= toTs)) {
              entry._source = path;
              allData.push(entry);
              Object.keys(entry).forEach(k => headersSet.add(k));
            }
          });

          renderTable(Array.from(headersSet), allData);
        });
      });
    }

    function renderTable(headers, rows) {
      tableHeaders.innerHTML = "";
      headers.forEach(h => {
        let th = document.createElement("th");
        th.textContent = h;
        tableHeaders.appendChild(th);
      });
      tableBody.innerHTML = "";
      rows.forEach(row => {
        let tr = document.createElement("tr");
        headers.forEach(h => {
          let td = document.createElement("td");
          td.textContent = row[h] !== undefined ? row[h] : "";
          tr.appendChild(td);
        });
        tableBody.appendChild(tr);
      });
    }

    function exportCSV() {
      const rows = document.querySelectorAll("table tr");
      let csv = [];
      for (let row of rows) {
        let cols = row.querySelectorAll("th, td");
        csv.push(Array.from(cols).map(td => `"${td.innerText}"`).join(","));
      }
      const blob = new Blob([csv.join("\n")], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.setAttribute("href", url);
      a.setAttribute("download", `energy_data_${Date.now()}.csv`);
      a.click();
    }

    fetchPaths();
  </script>
</body>
</html>
