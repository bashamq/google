<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Energy Dashboard</title>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    .card:hover {
      transform: scale(1.05);
      transition: all 0.3s ease;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    body {
      font-size: 1.06rem;
    }
  </style>
</head>

<body class="bg-gray-100 text-gray-800">

  <!-- Header -->
  <header class="bg-green-700 text-white p-4 flex justify-between items-center">
    <div class="flex items-center gap-4">
      <label for="pathSelector" class="font-semibold">Select Path:</label>
      <select id="pathSelector" class="text-black p-1 rounded"></select>
    </div>
    <h1 class="text-xl font-bold text-center flex-1">Smart Energy Dashboard</h1>
    <div id="clock" class="text-sm font-semibold"></div>
  </header>

  <!-- Selected Path -->
  <div class="bg-white shadow p-2 text-center text-green-800 font-semibold text-lg">
    <span id="currentPath">Loading...</span>
  </div>

  <!-- Main -->
  <main class="p-4 container mx-auto">
    <section id="cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8"></section>

    <!-- Live Graph -->
    <section class="bg-white rounded-xl shadow-md p-4">
      <h2 class="text-center text-lg font-bold mb-2">Live Graph</h2>
      <canvas id="lineChart" height="100"></canvas>
      <div class="text-center mt-4 flex justify-center gap-4">
        <button onclick="downloadChartPDF()" class="bg-green-600 text-white px-4 py-2 rounded">Download Live Chart as
          PDF</button>
        <button onclick="openHistoryModal()" class="bg-blue-600 text-white px-4 py-2 rounded">View History</button>
      </div>
    </section>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
      <div class="bg-white p-6 rounded-xl w-96 shadow-lg">
        <h2 class="text-lg font-bold mb-4 text-center">View History Data</h2>

        <label class="block mb-2 font-semibold">Select Sheet:</label>
        <select id="sheetSelector" class="border p-2 w-full rounded mb-3">
          <option value="1ploDMTUoV9bxDKVuGtlA4ARlUxgyglO1FHrT8G26hWI">Machine_shop_main</option>
          <option value="1fX9tLZg0IcLCzE0_mshodYJMAINiDdC0sXiUmo8Hr6U">New_Compressor</option>
          <option value="1VL_cjpkJCgS6WH53bTVReTJ6UTzV2Pzh5OUcmH16REg">Compressors</option>
        </select>

        <label class="block mb-2 font-semibold">Start Date & Time:</label>
        <input type="datetime-local" id="startDate" class="border p-2 w-full rounded mb-3">

        <label class="block mb-2 font-semibold">End Date & Time:</label>
        <input type="datetime-local" id="endDate" class="border p-2 w-full rounded mb-3">

        <div class="flex justify-between mt-4">
          <button onclick="fetchHistoryData()" class="bg-blue-600 text-white px-3 py-2 rounded">Show</button>
          <button onclick="closeHistoryModal()" class="bg-gray-500 text-white px-3 py-2 rounded">Close</button>
        </div>
      </div>
    </div>

    <!-- History Graph -->
    <div id="historyGraphSection" class="hidden bg-white rounded-xl shadow-md p-4 mt-6">
      <h2 class="text-center text-lg font-bold mb-2">History Graph</h2>
      <canvas id="historyChart" height="100"></canvas>
      <div class="text-center mt-4 flex justify-center gap-4">
        <button onclick="downloadHistoryPDF()" class="bg-green-600 text-white px-4 py-2 rounded">Download PDF</button>
        <button onclick="downloadHistoryCSV()" class="bg-orange-600 text-white px-4 py-2 rounded">Download CSV</button>
      </div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, off, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyApTAM7ZAvxHBDjVNFe7ARN5iNtshA8TFQ",
      authDomain: "energy-monitoring-chenab-60e72.firebaseapp.com",
      databaseURL: "https://energy-monitoring-chenab-60e72-default-rtdb.firebaseio.com/",
      projectId: "energy-monitoring-chenab-60e72",
      storageBucket: "energy-monitoring-chenab-60e72.appspot.com"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const fields = ["AVERAGE_PHASE_VOLTAGE", "Average_current", "TOTAL_POWER", "Timestamp"];
    const chartLabels = [], chartDataVoltage = [], chartDataCurrent = [], chartDataPower = [];

    const chartCtx = document.getElementById("lineChart").getContext("2d");
    const chart = new Chart(chartCtx, {
      type: "line",
      data: {
        labels: chartLabels,
        datasets: [
          { label: "Average Voltage", data: chartDataVoltage, borderColor: "blue", fill: false },
          { label: "Average Current", data: chartDataCurrent, borderColor: "orange", fill: false },
          { label: "Total Power", data: chartDataPower, borderColor: "green", fill: false }
        ]
      },
      options: { responsive: true }
    });

    const cardsContainer = document.getElementById("cards");
    const pathSelector = document.getElementById("pathSelector");
    const clockEl = document.getElementById("clock");
    let lastPath = null;

    async function loadPaths() {
      const rootRef = ref(database);
      const snapshot = await get(rootRef);
      if (snapshot.exists()) {
        const paths = Object.keys(snapshot.val());
        pathSelector.innerHTML = "";
        paths.forEach(p => {
          const option = document.createElement("option");
          option.value = p;
          option.textContent = p;
          pathSelector.appendChild(option);
        });
        if (paths.length > 0) {
          pathSelector.value = paths[0];
          loadData(paths[0]);
        }
      }
    }

    function loadData(path) {
      document.getElementById("currentPath").textContent = path;
      if (lastPath) off(ref(database, lastPath));
      lastPath = path;
      const dbRef = ref(database, path);
      onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;
        const timestamp = new Date().toLocaleTimeString("en-PK", { timeZone: "Asia/Karachi" });
        if (chartLabels.length > 50) { chartLabels.shift(); chartDataVoltage.shift(); chartDataCurrent.shift(); chartDataPower.shift(); }
        chartLabels.push(timestamp);
        chartDataVoltage.push(data.AVERAGE_PHASE_VOLTAGE || 0);
        chartDataCurrent.push(data.Average_current || 0);
        chartDataPower.push(data.TOTAL_POWER || 0);
        chart.update();
        feather.replace();
      });
    }
    pathSelector.addEventListener("change", () => loadData(pathSelector.value));
    setInterval(() => clockEl.textContent = new Date().toLocaleString("en-PK", { timeZone: "Asia/Karachi" }), 1000);
    loadPaths();

    // --- Live Chart PDF ---
    window.downloadChartPDF = function () {
      const { jsPDF } = window.jspdf;
      html2canvas(document.getElementById("lineChart")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF('landscape');
        pdf.text("Smart Energy Dashboard - Live Graph", 14, 15);
        pdf.addImage(imgData, 'PNG', 10, 20, 270, 150);
        pdf.save("live_chart.pdf");
      });
    }

    // --- History Functions ---
    let historyChart;
    window.openHistoryModal = () => document.getElementById("historyModal").classList.remove("hidden");
    window.closeHistoryModal = () => document.getElementById("historyModal").classList.add("hidden");

    async function fetchSheetHistory(sheetId, start, end) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&gid=0`;
      const raw = await fetch(url).then(r => r.text());
      const json = JSON.parse(raw.substring(raw.indexOf('{'), raw.lastIndexOf('}') + 1));
      const rows = json.table.rows || [];
      const result = [];
      rows.forEach(r => {
        if (!r.c) return;
        const ts = r.c[0]?.v, avgVolt = r.c[2]?.v, avgCurr = r.c[3]?.v, totPow = r.c[4]?.v, phaseVolt = r.c[5]?.v;
        const timestamp = new Date(ts);
        if (timestamp >= start && timestamp <= end) {
          result.push({ time: timestamp.toLocaleString(), avgVolt, avgCurr, totPow, phaseVolt });
        }
      });
      return result;
    }

    window.fetchHistoryData = async function () {
      const sheetId = document.getElementById("sheetSelector").value;
      const start = new Date(document.getElementById("startDate").value);
      const end = new Date(document.getElementById("endDate").value);
      if (!start || !end || start >= end) { alert("Select valid date/time"); return; }
      const historyData = await fetchSheetHistory(sheetId, start, end);
      if (!historyData.length) { alert("No data in this range"); return; }
      const labels = historyData.map(d => d.time);
      const avgVolt = historyData.map(d => parseFloat(d.avgVolt) || 0);
      const avgCurr = historyData.map(d => parseFloat(d.avgCurr) || 0);
      const totPow = historyData.map(d => parseFloat(d.totPow) || 0);
      const phaseVolt = historyData.map(d => parseFloat(d.phaseVolt) || 0);
      if (historyChart) historyChart.destroy();
      historyChart = new Chart(document.getElementById("historyChart"), {
        type: "line",
        data: {
          labels,
          datasets: [
            { label: "Average Voltage", data: avgVolt, borderColor: "blue", fill: false },
            { label: "Average Current", data: avgCurr, borderColor: "orange", fill: false },
            { label: "Total Power", data: totPow, borderColor: "green", fill: false },
            { label: "AVERAGE_PHASE_VOLTAGE", data: phaseVolt, borderColor: "red", fill: false }
          ]
        }
      });
      document.getElementById("historyGraphSection").classList.remove("hidden");
      closeHistoryModal();
    }

    window.downloadHistoryPDF = function () {
      const { jsPDF } = window.jspdf;
      html2canvas(document.getElementById("historyChart")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jsPDF('landscape');
        pdf.text("Smart Energy Dashboard - History Graph", 14, 15);
        pdf.addImage(imgData, 'PNG', 10, 20, 270, 150);
        pdf.save("history_chart.pdf");
      });
    }

    window.downloadHistoryCSV = function () {
      const labels = historyChart.data.labels;
      const datasets = historyChart.data.datasets;
      let csv = "Time,Average Voltage,Average Current,Total Power,AVERAGE_PHASE_VOLTAGE\n";
      labels.forEach((label, i) => {
        csv += `${label},${datasets[0].data[i]},${datasets[1].data[i]},${datasets[2].data[i]},${datasets[3].data[i]}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "history_data.csv";
      a.click();
    }
  </script>
</body>

</html>
